# Schema Context â€” PostgreSQL Implementation for OCR and Document Processing

## Overview
This PostgreSQL schema defines all the core entities required for the OCR-driven insurance document automation system.  
It supports unstructured-to-structured workflows including ingestion, OCR extraction, AI parsing, semantic embedding, and audit traceability.

---

```sql
-- ==============================
-- INSURED PARTIES TABLE
-- ==============================
CREATE TABLE insured_parties (
  insured_party_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  contact_info JSONB,
  entity_type VARCHAR(50) CHECK (entity_type IN ('Individual', 'Company')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==============================
-- POLICIES TABLE
-- ==============================
CREATE TABLE policies (
  policy_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  insured_party_id UUID REFERENCES insured_parties(insured_party_id) ON DELETE SET NULL,
  policy_type VARCHAR(100),
  issue_date DATE,
  expiration_date DATE,
  premium_amount NUMERIC(12,2),
  coverage_details JSONB,
  status VARCHAR(50) CHECK (status IN ('Active', 'Expired', 'Underwriting', 'Cancelled')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==============================
-- DOCUMENTS TABLE
-- ==============================
CREATE TABLE documents (
  document_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  policy_id UUID REFERENCES policies(policy_id) ON DELETE SET NULL,
  insured_party_id UUID REFERENCES insured_parties(insured_party_id) ON DELETE SET NULL,
  type VARCHAR(100) CHECK (type IN ('policy', 'claim', 'schedule', 'loss_run', 'contract')),
  upload_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  file_url TEXT NOT NULL,
  raw_text TEXT,
  embeddings VECTOR(1536),  -- assuming OpenAI or similar embedding dimension
  structured_data JSONB,
  status VARCHAR(50) CHECK (status IN ('Pending', 'Extracted', 'Validated', 'Failed')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==============================
-- EXTRACTION RESULTS TABLE
-- ==============================
CREATE TABLE extraction_results (
  extraction_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID REFERENCES documents(document_id) ON DELETE CASCADE,
  extractor_type VARCHAR(50) CHECK (extractor_type IN ('OCR', 'LLM', 'Hybrid')),
  result_json JSONB,
  validated_by VARCHAR(255),
  validation_date DATE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==============================
-- CLAIMS TABLE
-- ==============================
CREATE TABLE claims (
  claim_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  policy_id UUID REFERENCES policies(policy_id) ON DELETE SET NULL,
  insured_party_id UUID REFERENCES insured_parties(insured_party_id) ON DELETE SET NULL,
  filed_date DATE,
  status VARCHAR(50) CHECK (status IN ('Open', 'Closed', 'Pending', 'Denied')),
  claim_details JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ==============================
-- KNOWLEDGE GRAPH EDGES TABLE
-- ==============================
CREATE TABLE knowledge_graph_edges (
  edge_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  subject_id VARCHAR(255) NOT NULL,
  predicate VARCHAR(255) NOT NULL,
  object_id VARCHAR(255) NOT NULL,
  metadata JSONB
);

-- ==============================
-- AUDIT & WORKFLOW TABLE
-- ==============================
CREATE TABLE audit_workflow (
  workflow_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID REFERENCES documents(document_id) ON DELETE CASCADE,
  event_type VARCHAR(100) CHECK (event_type IN ('OCR', 'Extraction', 'Classification', 'Review', 'API_Sync')),
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  status VARCHAR(50) CHECK (status IN ('Success', 'Error', 'Pending')),
  details JSONB
);

-- ==============================
-- INDEXES FOR PERFORMANCE
-- ==============================
CREATE INDEX idx_documents_policy_id ON documents(policy_id);
CREATE INDEX idx_documents_insured_party_id ON documents(insured_party_id);
CREATE INDEX idx_extraction_results_document_id ON extraction_results(document_id);
CREATE INDEX idx_claims_policy_id ON claims(policy_id);
CREATE INDEX idx_audit_workflow_document_id ON audit_workflow(document_id);

-- Full-text search index for OCR text (optional)
CREATE INDEX idx_documents_raw_text_gin ON documents USING gin(to_tsvector('english', raw_text));

-- Vector similarity search index (for embeddings)
CREATE INDEX idx_documents_embeddings ON documents USING ivfflat (embeddings vector_l2_ops);
