---
alwaysApply: false
---

# Schema Context — PostgreSQL Implementation for OCR and Document Processing

## Overview
This PostgreSQL schema defines all the core entities required for the OCR-driven insurance document automation system.  
It supports unstructured-to-structured workflows including ingestion, OCR extraction, AI parsing, semantic embedding, and audit traceability.

---

```sql
-- =====================================================================
-- USERS TABLE (Clerk-auth integrated)
-- =====================================================================
CREATE TABLE users (
    id UUID PRIMARY KEY,
    clerk_user_id TEXT UNIQUE NOT NULL,
    email TEXT NOT NULL,
    full_name TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- DOCUMENTS (raw uploaded files)
-- =====================================================================
CREATE TABLE documents (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    file_path TEXT NOT NULL,
    mime_type TEXT,
    page_count INT,
    status TEXT NOT NULL DEFAULT 'uploaded',  -- uploaded | ocr_processing | ocr_processed | classified | extracted
    uploaded_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- DOCUMENT_PAGES (page-level metadata for PDFs/images)
-- =====================================================================
CREATE TABLE document_pages (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    page_number INT NOT NULL,
    image_path TEXT,               -- optional: per-page image used for OCR
    width INT,
    height INT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- DOCUMENT_RAW_TEXT (OCR text per page)
-- =====================================================================
CREATE TABLE document_raw_text (
    id UUID PRIMARY KEY,
    document_page_id UUID REFERENCES document_pages(id) ON DELETE CASCADE,
    text_content TEXT NOT NULL,
    confidence NUMERIC,            -- average confidence (from OCR)
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- OCR_RESULTS (document-level full OCR)
-- =====================================================================
CREATE TABLE ocr_results (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    ocr_provider TEXT NOT NULL,        -- mistral_ocr | tesseract | gcv
    raw_text TEXT,                     -- concatenated text of all pages
    confidence NUMERIC,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- OCR_TOKENS (optional, token-level OCR structure)
-- Helps for advanced layout understanding & LLM post-processing
-- =====================================================================
CREATE TABLE ocr_tokens (
    id UUID PRIMARY KEY,
    document_page_id UUID REFERENCES document_pages(id) ON DELETE CASCADE,
    token TEXT NOT NULL,
    x_min INT,
    y_min INT,
    x_max INT,
    y_max INT,
    confidence NUMERIC,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- DOCUMENT_CLASSIFICATIONS
-- (Mistral Classifier Factory / LLM fallback)
-- =====================================================================
CREATE TABLE document_classifications (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    classified_type TEXT NOT NULL,     -- policy | claim | quote | submission | SOV | proposal | audit | financials
    confidence NUMERIC,
    classifier_model TEXT,             -- mistral_classifier_factory | gpt | claude | rules_model
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- EXTRACTED_FIELDS (LLM / rules / hybrid)
-- =====================================================================
CREATE TABLE extracted_fields (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    field_name TEXT NOT NULL,
    field_value TEXT,
    confidence NUMERIC,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- WORKFLOWS (Temporal workflow instances)
-- =====================================================================
CREATE TABLE workflows (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    workflow_type TEXT NOT NULL,    -- claims_intake | policy_comparison | submission | proposal_generation
    temporal_workflow_id TEXT UNIQUE,
    status TEXT NOT NULL DEFAULT 'running',  -- running | completed | failed
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- WORKFLOW_RUN_EVENTS (audit trail)
-- =====================================================================
CREATE TABLE workflow_run_events (
    id UUID PRIMARY KEY,
    workflow_id UUID REFERENCES workflows(id) ON DELETE CASCADE,
    event_type TEXT NOT NULL,
    event_payload JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- SUBMISSIONS WORKFLOW TABLE (Property / Auto / Commercial etc)
-- =====================================================================
CREATE TABLE submissions (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    submission_type TEXT,             -- property | auto | commercial
    agent_name TEXT,
    insured_name TEXT,
    effective_date DATE,
    expiration_date DATE,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- POLICY COMPARISON WORKFLOW OUTPUT
-- =====================================================================
CREATE TABLE policy_comparisons (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    comparison_json JSONB,            -- normalized coverage differences
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- CLAIMS INTAKE WORKFLOW OUTPUT
-- =====================================================================
CREATE TABLE claims (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    claim_number TEXT,
    insured_name TEXT,
    loss_date DATE,
    loss_description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- QUOTE COMPARISON WORKFLOW TABLE
-- =====================================================================
CREATE TABLE quotes (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    carrier_name TEXT,
    premium NUMERIC,
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- PROPOSAL GENERATION WORKFLOW TABLE
-- =====================================================================
CREATE TABLE proposals (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    proposal_json JSONB,
    generated_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- FINANCIAL ANALYSIS WORKFLOW TABLE
-- (D&O financial statements processing)
-- =====================================================================
CREATE TABLE financial_analysis (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    extracted_metrics JSONB,
    risk_assessment TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- =====================================================================
-- SOV — Statement of Values
-- =====================================================================
CREATE TABLE property_sov (
    id UUID PRIMARY KEY,
    document_id UUID REFERENCES documents(id),
    sov_json JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
