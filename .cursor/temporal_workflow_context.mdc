# Workflow Orchestration Context — Temporal Integration

## Purpose
This context defines how the OCR and downstream extraction workflows are orchestrated using **Temporal** to ensure reliability, fault tolerance, and scalability.

---

## Workflow Overview

### Workflow Name:
`DocumentProcessingWorkflow`

### Steps:

1. **IngestionActivity**
   - Triggered when a new document is uploaded.
   - Stores document metadata in DB (`documents` table, status = `Pending`).
   - Emits event `DOCUMENT_RECEIVED`.

2. **OCRExtractionActivity**
   - Invoked after ingestion event.
   - Calls Mistral OCR (or fallback OCR) to extract text/layout.
   - Updates `documents.raw_text` and `status = 'OCR_COMPLETED'`.
   - Emits `OCR_COMPLETED` event.

3. **DocumentClassificationActivity**
   - Consumes OCR output.
   - Uses an LLM classifier or rule-based approach to label the document type (Policy, Claim, Loss Run).
   - Updates `documents.type`.

4. **InformationExtractionActivity**
   - Triggers AI-based extraction of structured data (policy fields, claim details).
   - Stores results in `extraction_results.result_json`.

5. **EmbeddingGenerationActivity**
   - Converts OCR text into vector embeddings.
   - Updates `documents.embeddings`.

6. **ValidationActivity (optional)**
   - Performs human or automated review.
   - Updates `extraction_results.validated_by` and `validation_date`.

7. **AuditAndFinalizeActivity**
   - Logs all steps to `audit_workflow`.
   - Marks document `status = 'Validated'`.

---

## Temporal Features

### Retry Policy
```yaml
max_attempts: 3
initial_interval: 30s
backoff_coefficient: 2.0
max_interval: 5m
```

## Error Handling

- **ApplicationFailure:** Retried automatically.  
- **NonRetryableFailure:** Logged, marked as failed in `audit_workflow`.

---

## Signals & Events

- **signal.NewDocumentUploaded:** Starts new workflow run.  
- **signal.OCRCompleted:** Triggers classification.  
- **signal.ValidationApproved:** Proceeds to finalization.

---

## Workflow Timeout

- **workflowExecutionTimeout:** 1 hour *(can be extended for large batch documents)*

[User Upload] 
   ↓
[Temporal: IngestionActivity] 
   ↓
[Temporal: OCRExtractionActivity (Mistral/Tesseract)]
   ↓
[Temporal: ClassificationActivity]
   ↓
[Temporal: Extraction + Embedding + Validation]
   ↓
[Audit Workflow + Structured Output Ready]
