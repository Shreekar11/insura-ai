{
  "openapi": "3.0.3",
  "info": {
    "title": "Citations API",
    "version": "1.0.0",
    "description": "API for document citations, text highlighting, and PDF coordinate references."
  },
  "paths": {
    "/api/v1/documents/{document_id}/citations": {
      "get": {
        "summary": "Get all citations for a document",
        "operationId": "get_document_citations",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Unique identifier of the document"
          }
        ],
        "responses": {
          "200": {
            "description": "Citations retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": {
                          "$ref": "#/components/schemas/CitationsResponse"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "404": {
            "description": "Document not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          }
        },
        "security": [
          {
            "bearerAuth": []
          }
        ]
      }
    },
    "/api/v1/documents/{document_id}/citations/{source_type}/{source_id}": {
      "get": {
        "summary": "Get a specific citation by source type and ID",
        "operationId": "get_citation_by_source",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Unique identifier of the document"
          },
          {
            "name": "source_type",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "enum": [
                "effective_coverage",
                "effective_exclusion",
                "endorsement",
                "condition",
                "clause"
              ]
            },
            "description": "Type of source being cited"
          },
          {
            "name": "source_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "Canonical or stable ID of the source item"
          }
        ],
        "responses": {
          "200": {
            "description": "Citation retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": {
                          "$ref": "#/components/schemas/Citation"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "404": {
            "description": "Citation not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          }
        },
        "security": [
          {
            "bearerAuth": []
          }
        ]
      }
    },
    "/api/v1/documents/{document_id}/pages/{page_number}/dimensions": {
      "get": {
        "summary": "Get page dimensions for coordinate transformation",
        "operationId": "get_page_dimensions",
        "parameters": [
          {
            "name": "document_id",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Unique identifier of the document"
          },
          {
            "name": "page_number",
            "in": "path",
            "required": true,
            "schema": {
              "type": "integer",
              "minimum": 1
            },
            "description": "Page number (1-indexed)"
          }
        ],
        "responses": {
          "200": {
            "description": "Page dimensions retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "allOf": [
                    { "$ref": "#/components/schemas/ApiResponse" },
                    {
                      "type": "object",
                      "properties": {
                        "data": {
                          "$ref": "#/components/schemas/PageDimensions"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "404": {
            "description": "Document or page not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorDetail" }
              }
            }
          }
        },
        "security": [
          {
            "bearerAuth": []
          }
        ]
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "BoundingBox": {
        "type": "object",
        "description": "Represents a bounding box in PDF coordinate space. Coordinates use the PDF standard coordinate system where origin (0,0) is at the bottom-left corner of the page. All values are in points (1/72 inch).",
        "required": ["x0", "y0", "x1", "y1"],
        "properties": {
          "x0": {
            "type": "number",
            "format": "float",
            "description": "X coordinate of bottom-left corner"
          },
          "y0": {
            "type": "number",
            "format": "float",
            "description": "Y coordinate of bottom-left corner"
          },
          "x1": {
            "type": "number",
            "format": "float",
            "description": "X coordinate of top-right corner"
          },
          "y1": {
            "type": "number",
            "format": "float",
            "description": "Y coordinate of top-right corner"
          }
        }
      },
      "CitationSpan": {
        "type": "object",
        "description": "Represents a continuous span of text on a single page with its location. A citation may span multiple pages.",
        "required": ["page_number", "bounding_boxes", "text_content"],
        "properties": {
          "page_number": {
            "type": "integer",
            "minimum": 1,
            "description": "Page number (1-indexed)"
          },
          "bounding_boxes": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/BoundingBox"
            },
            "description": "Array of bounding boxes for this span (multiple if text wraps across lines)"
          },
          "text_content": {
            "type": "string",
            "description": "The text content for this span"
          }
        }
      },
      "PageRange": {
        "type": "object",
        "description": "Represents a range of pages in a document",
        "required": ["start", "end"],
        "properties": {
          "start": {
            "type": "integer",
            "minimum": 1,
            "description": "Starting page number (1-indexed, inclusive)"
          },
          "end": {
            "type": "integer",
            "minimum": 1,
            "description": "Ending page number (1-indexed, inclusive)"
          }
        }
      },
      "Citation": {
        "type": "object",
        "description": "Represents a citation with its location, content, and metadata. Links extracted insurance policy content to its original location in the source PDF.",
        "required": [
          "id",
          "document_id",
          "source_type",
          "source_id",
          "spans",
          "verbatim_text",
          "primary_page"
        ],
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique identifier for this citation"
          },
          "document_id": {
            "type": "string",
            "format": "uuid",
            "description": "ID of the source document"
          },
          "source_type": {
            "type": "string",
            "enum": [
              "effective_coverage",
              "effective_exclusion",
              "endorsement",
              "condition",
              "clause"
            ],
            "description": "Type of the source being cited"
          },
          "source_id": {
            "type": "string",
            "description": "Canonical or stable ID of the source item"
          },
          "spans": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CitationSpan"
            },
            "description": "Array of spans representing the citation across one or more pages"
          },
          "verbatim_text": {
            "type": "string",
            "description": "The complete verbatim text from the source document"
          },
          "primary_page": {
            "type": "integer",
            "minimum": 1,
            "description": "Primary page number where the citation appears"
          },
          "page_range": {
            "allOf": [
              { "$ref": "#/components/schemas/PageRange" }
            ],
            "nullable": true,
            "description": "Optional range of pages if citation spans multiple pages"
          },
          "extraction_confidence": {
            "type": "number",
            "format": "float",
            "minimum": 0,
            "maximum": 1,
            "nullable": true,
            "description": "Optional confidence score for the extraction (0-1)"
          },
          "extraction_method": {
            "type": "string",
            "enum": ["docling", "pdfplumber", "manual"],
            "nullable": true,
            "description": "Optional method used to extract this citation"
          },
          "clause_reference": {
            "type": "string",
            "nullable": true,
            "description": "Optional reference to a specific clause (e.g., '2.3.1')"
          },
          "resolution_method": {
            "type": "string",
            "enum": ["direct_text_match", "semantic_chunk_match", "placeholder"],
            "nullable": true,
            "description": "How the citation was resolved: direct_text_match (exact/fuzzy word match), semantic_chunk_match (embedding-based chunk search), or placeholder (full-page fallback)"
          }
        }
      },
      "PageDimensions": {
        "type": "object",
        "description": "Represents the physical dimensions of a PDF page. Dimensions are in points (1/72 inch) following PDF standards.",
        "required": ["page_number", "width_points", "height_points", "rotation"],
        "properties": {
          "page_number": {
            "type": "integer",
            "minimum": 1,
            "description": "Page number (1-indexed)"
          },
          "width_points": {
            "type": "number",
            "format": "float",
            "description": "Width of the page in points"
          },
          "height_points": {
            "type": "number",
            "format": "float",
            "description": "Height of the page in points"
          },
          "rotation": {
            "type": "integer",
            "enum": [0, 90, 180, 270],
            "description": "Rotation of the page in degrees"
          }
        }
      },
      "CitationsResponse": {
        "type": "object",
        "description": "Response structure for fetching citations with their associated page dimensions",
        "required": ["citations", "page_dimensions"],
        "properties": {
          "citations": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Citation"
            },
            "description": "Array of citations for the document"
          },
          "page_dimensions": {
            "type": "object",
            "additionalProperties": {
              "$ref": "#/components/schemas/PageDimensions"
            },
            "description": "Map of page numbers to their dimensions for coordinate transformation"
          }
        }
      },
      "ApiResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "boolean"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "type": "object"
          },
          "meta": {
            "$ref": "#/components/schemas/ResponseMeta"
          }
        },
        "required": ["status", "message", "data", "meta"]
      },
      "ResponseMeta": {
        "type": "object",
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "request_id": {
            "type": "string"
          },
          "api_version": {
            "type": "string",
            "default": "v1"
          }
        },
        "required": ["timestamp", "request_id", "api_version"]
      },
      "ErrorDetail": {
        "type": "object",
        "properties": {
          "title": {
            "type": "string"
          },
          "status": {
            "type": "integer"
          },
          "detail": {
            "type": "string"
          },
          "instance": {
            "type": "string",
            "nullable": true
          },
          "request_id": {
            "type": "string"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": ["title", "status", "detail", "request_id", "timestamp"]
      }
    }
  }
}
